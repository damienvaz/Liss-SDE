<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>jsTree test</title>
    <!-- 2 load the theme CSS file -->
    <link rel="stylesheet" href="dist/themes/default/style.css" />
</head>
<body>


<div id="lissSyntax"></div>
<!--<input type="button" value="Load" onclick="loadTreeJSON()"/>-->

<!-- 4 include the jQuery library -->
<script src="dist/libs/jquery.min.js"></script>
<!-- 5 include the minified jstree source -->
<!--<script src="dist/jstree.min.js"></script>-->
<script src="dist/jstree.min.js"></script>
<script>
    var num=0;
    var tab=0;

    function getStateJson(){
        num = liss.getNum();
        tab = liss.getTab();
    }

    function setStateJson(){
        liss.setStateJsonLiss(num,tab);
    }

    function produceTabs(tab){
        var res = "";
        for (i = 0; i < tab; i++) {
            res +=  "    ";
        }
        return res;
    }

    function saveTreeJSON(){
        var v = $('#lissSyntax').jstree(true).get_json('#', {flat:true});
        setStateJson();
        var num = ""+liss.getNum();
        var tab = ""+liss.getTab();
        var mytext = JSON.stringify(v);
        mytext = num+"\n"+tab+"\n"+mytext;
        return mytext;
    }

    function loadTreeJSON(){
        var test = liss.getJSON();

        var json = JSON.parse(test);
        if($('#lissSyntax').jstree(true)){
            $('#lissSyntax').jstree(true).settings.core.data = json;
            $('#lissSyntax').jstree(true).refresh();
            liss.setText(getProgramLiss());
        }
    }



    function getProgramLiss(){
        var res="";
        $('.terminal').each(function(){
            //var text = $(this).text();
            var text;
            if($(this).hasClass("edit")){
                if($(this).hasClass("correct")) {
                    if ($(this).attr("expressionregularrule") === "ID") {
                        text = $(this).attr("program") + $(this).text();//+$(this).attr("program");
                    } else if ($(this).attr("expressionregularrule") === "NBR") {
                        text = $(this).attr("program") + $(this).text();
                    }
                }
            }else{
                //console.log("ELSE: ");
                //console.log($(this));
                text = $(this).attr("program");
            }
            res += text;
        });

        return res;
    }

    $('#lissSyntax').on('mouseenter',function(){ //event optional : click
        var res = getProgramLiss();
        liss.setText(res);
    });

    $('#lissSyntax').on("set_text.jstree",function(event,object){
        var id = object.obj.a_attr.id;
        var node = $("#"+id);
        //ID : ('a'..'z'|'A'..'Z')('a'..'z'|'A'..'Z'|'0'..'9'|'_')* //removi o uso do signal '-' conflitos com os valores do signal
        var patternId = /^([a-z]|[A-Z])([a-z]|[A-Z]|[0-9]|[_])*$/;
        //NBR : ('0'..'9')+
        var patternNbr = /^[0-9]+$/;

        var patternEscSeq = /\\(b|t|n|f|r|"|'|\\)/;
        var patternStr = /".*"/;     // -> /"(\\(b|t|n|f|r|"|'|\\)|[^"])*"/;

        //Pr.C.:Check if the node has an expression regular rule as attribute
        if(node.is("[expressionregularrule]") && node.hasClass("edit")){
            //Pr.C.:Check which type of node is it. (Ex.: NBR|ID|STR)
            if(node.attr("expressionregularrule")==="NBR"){
                //console.log("regra NBR");
                //Pr.C:When edition is actived, the text element is empty
                if(object.obj.text!=="") {
                    //Pr.C.: Check the regular expression of NBR
                    if (patternNbr.test(object.obj.text)) {
                        if(/warning/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" warning", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.removeClass("warning");
                            node.addClass("correct");
                        }else if(!/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.addClass("correct");
                        }
                    } else {
                        if(/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" correct", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" warning";
                            //Changing value now for the DOM html document structure
                            node.removeClass("correct");
                            node.addClass("warning");
                        }else if(!/warning/.test(object.obj.a_attr.class)){
                            //Changing value now for the DOM html document structure
                            node.addClass("warning");
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" warning";
                        }
                    }
                }
            }else if(node.attr("expressionregularrule")==="ID"){
                //console.log("regra ID");
                //Pr.C:When edition is actived, the text element is empty
                if(object.obj.text!=="") {
                    //Pr.C.: Check the regular expression of NBR
                    if (patternId.test(object.obj.text)) {
                        if(/warning/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" warning", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.removeClass("warning");
                            node.addClass("correct");
                        }else if(!/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.addClass("correct");
                        }
                    } else {
                        if(/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" correct", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" warning";
                            //Changing value now for the DOM html document structure
                            node.removeClass("correct");
                            node.addClass("warning");
                        }else if(!/warning/.test(object.obj.a_attr.class)){
                            //Changing value now for the DOM html document structure
                            node.addClass("warning");
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" warning";
                        }
                    }
                    console.log(object.obj.a_attr.class);
                }
            }else if(node.attr("expressionregularrule")==="STR"){
                console.log("regra STR");
                //FAZER ESTA PARTE
            }

        }
    });

    /**************************************************************************/


    $("#lissSyntax").jstree({
        "core": {
            // so that create works
            "themes": {
                "icons": false
            },
            "check_callback": true,
            "data": [{
                "id": "liss", "parent": "#", "text": "liss", a_attr: {"class": "non-terminal"}
            }]
        },
        "plugins": ["contextmenu"],
        "contextmenu": {
            "items": customMenu
        }
    });

    //Regular expression for some node id !!!
    var patternDeclarations=/^declarations[0-9]+$/;
    //var patternDeclaration=/^declaration[0-9]+$/;
    var patternStatements=/^statements[0-9]+$/;
    var patternVariablesDeclarations = /^variables_declarations[0-9]+$/;
    var patternSubprogramsDefinitions = /^subprograms_definitions[0-9]+$/;
    var patternVariableDeclaration = /^variable_declaration[0-9]+$/;
    var patternType = /^type[0-9]+$/;
    var patternInteger = /^integer[0-9]+$/;
    var patternBoolean = /^boolean[0-9]+$/;
    var patternSet = /^set[0-9]+$/;
    var patternSequence = /^sequence[0-9]+$/;
    var patternArray = /^array[0-9]+$/;
    var patternSize = /^size[0-9]+$/;
    var patternDimension = /^dimension[0-9]+$/;
    var patternNumbers = /^numbers[0-9]+$/;
    var patternNumber = /^number[0-9]+$/;
    var patternSubprogramDefinition = /^subprogram_definition[0-9]+$/;
    var patternVars = /^vars[0-9]+$/;
    var patternVar = /^var[0-9]+$/;
    var patternValueVar=/^value_var[0-9]+$/;
    var patternInicVar = /^inic_var[0-9]+$/;
    var patternConstant = /^constant[0-9]+$/;
    var patternArrayDefinition = /^array_definition[0-9]+$/;
    var patternSetDefinition = /^set_definition[0-9]+$/;
    var patternSequenceDefinition = /^sequence_definition[0-9]+$/;
    /*********LEXER*********/
    var patternInt = /^int[0-9]+$/;
    var patternIdentifier = /^identifier[0-9]+$/;
    /***********************/

    function customMenu(node) {
        var items = null;

        if( node.id == "liss" && node.children.length==3){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            };
        }else if( node.id == "body" && node.children.length==6){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            };
        }else if(patternDeclarations.test(node.id)/*node.id == "declarations"*/ && node.children.length==1){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            };
        }else if(patternVariablesDeclarations.test(node.id)/*node.id=="variable_declaration"*/){
            if(node.children.length<1){
                items = {
                    "add_variable_declaration" : {
                        "label" : "Add variable declaration",
                        "action" : function () {
                            //Node : variable_declaration
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "variable_declaration"+num, "text" : "variable_declaration",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "last", function(){});

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    }
                };
            }else{
                items = {
                    "add_variable_declaration" : {
                        "label" : "Add variable declaration",
                        "action" : function () {
                            //Node : variable_declaration
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "variable_declaration"+num, "text" : "variable_declaration",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "last", function(){});

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    },
                    "delete" : {
                        "label" : "Delete Rule",
                        "action" : function () {
                            //liss.debugger("WOOT1");
                            //liss.debugger(node.children);
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                            //liss.debugger("WOOT2");
                        }
                    }
                };
            }
        }else if(patternSubprogramsDefinitions.test(node.id)/*node.id=="subprogram_definition"*/){
            if(node.children.length<1){
                items = {
                     "add_subprogram_definition" : {
                         "label" : "Add subprogram definition",
                         "action" : function () {
                         //Node : subprogram_definition
                         $('#lissSyntax').jstree().create_node(node,  { "id" : "subprogram_definition"+num, "text" : "subprogram_definition",
                         state       : {
                         opened    : false,  // is the node open
                         disabled  : false,  // is the node disabled
                         }, a_attr : { "class" : "non-terminal"}
                         }, "last", function(){});

                         num++;

                         //Instruction for opening the branch
                         $("#lissSyntax").jstree("open_node", $("#"+node.id));
                         }
                     }
                };
            }else{
                items = {
                    "add_subprogram_definition" : {
                         "label" : "Add subprogram definition",
                         "action" : function () {
                         //Node : subprogram definition
                         $('#lissSyntax').jstree().create_node(node,  { "id" : "subprogram_definition"+num, "text" : "subprogram_definition",
                         state       : {
                         opened    : false,  // is the node open
                         disabled  : false,  // is the node disabled
                         }, a_attr : { "class" : "non-terminal"}
                         }, "last", function(){});

                         num++;

                         //Instruction for opening the branch
                         $("#lissSyntax").jstree("open_node", $("#"+node.id));
                         }
                     },
                    "delete" : {
                        "label" : "Delete Rule",
                        "action" : function () {
                            //liss.debugger("WOOT1");
                            //liss.debugger(node.children);
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                            //liss.debugger("WOOT2");
                        }
                    }
                };
            }
        }else if(patternVariableDeclaration.test(node.id)){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        //liss.debugger("WOOT1");
                        //liss.debugger(node.children);
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                        //liss.debugger("WOOT2");
                    }
                }
            };
        }else if(patternVars.test(node.id)){
            if(node.children.length ==1){

                items = {
                    "add_var" : {
                        "label" : "Add Var",
                        "action" : function () {
                            //Node : ,
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "comma"+num, "text": ",",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": " , "}
                            }, "last", function () {
                            });
                            num++;

                            //Node : var
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "var"+num, "text" : "var",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "last", function(){});

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    }
                };
            }else{
                items = {
                    "add_var": {
                        "label": "Add Var",
                        "action": function () {
                            //Node : ,
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "comma" + num, "text": ",",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": ", "}
                            }, "last", function () {
                            });
                            num++;

                            //Node : var
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "var" + num, "text": "var",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(node.children);

                            //Node : var
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "var" + num, "text": "var",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });

                            num++;

                            //$("#lissSyntax").jstree("open_node", $("#" + data.node.id));

                            //Refresh the content of TextArea
                            //liss.setText(getProgramLiss());
                        }
                    }
                }
            }
        }else if(patternVar.test(node.id)){
            var nodeParent = $("#lissSyntax").jstree(this).get_node(node.parent);
            var positionNodeInParent = function(nodeParent,node){
                var res=-1;
                for(var i=0; i < nodeParent.children.length;i++){
                    if(nodeParent.children[i]===node.id){res=i;}
                }
                return res;
            };
            var position = positionNodeInParent(nodeParent,node);


            if(nodeParent.children.length===1){
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {var numb
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                        }
                    }
                }
            }else if( nodeParent.children.length>1 && position >= 2 && position!= -1){
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(nodeParent.children[position]);
                            $("#lissSyntax").jstree(this).delete_node(nodeParent.children[position-1]);
                        }
                    }
                }
            }
        }else if(patternValueVar.test(node.id)){
            //blablabla
            if(node.children<1){
                items = {
                    "add_empty":{
                        "label": "Add Empty",
                        "action": function () {
                            //Node : =
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "empty" + num, "text": "empty",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": ""}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_inic_var": {
                        "label": "Add Inic_Var",
                        "action": function () {
                            //Node : =
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "equal" + num, "text": "=",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": " = "}
                            }, "last", function () {
                            });
                            num++;

                            //Node : inic_var
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "inic_var" + num, "text": "inic_var",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    }
                }
            }else{
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                        }
                    }
                }
            }
        }else if(patternInicVar.test(node.id)){
            if(node.children.length<1){
                items = {
                    "add_constant":{
                        "label": "Add Constant",
                        "action": function () {
                            //Node : contant
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "constant" + num, "text": "constant",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_array_definition": {
                        "label": "Add Array_Definition",
                        "action": function () {
                            //Node : array_definition
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "array_definition" + num, "text": "array_definition",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_set_definition": {
                        "label": "Add Set_Definition",
                        "action": function () {
                            //Node : set_definition
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "set_definition" + num, "text": "set_definition",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_sequence_definition": {
                        "label": "Add Sequence_Definition",
                        "action": function () {
                            //Node : sequence_definition
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "sequence_definition" + num, "text": "sequence_definition",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    }
                }
            }else{
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                        }
                    }
                }
            }
        }else if(patternType.test(node.id)){
            if(node.children.length<1){
                items = {
                    "add_integer":{
                        "label": "Add Integer",
                        "action": function () {
                            //Node : integer
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "integer" + num, "text": "integer",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": "integer "}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_boolean": {
                        "label": "Add Boolean",
                        "action": function () {
                            //Node : boolean
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "boolean" + num, "text": "boolean",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": "boolean "}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_set": {
                        "label": "Add Set",
                        "action": function () {
                            //Node : set
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "set" + num, "text": "set",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": "set "}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_sequence": {
                        "label": "Add Sequence",
                        "action": function () {
                            //Node : sequence
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "sequence" + num, "text": "sequence",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": "sequence "}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    },
                    "add_array_size_dimension": {
                        "label": "Add Array_Size_Dimension",
                        "action": function () {
                            //Node : array
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "array" + num, "text": "array",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": "array "}
                            }, "last", function () {
                            });
                            num++;

                            //Node : size
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "size" + num, "text": "size",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": "size "}
                            }, "last", function () {
                            });
                            num++;

                            //Node: dimension
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "dimension" + num, "text": "dimension",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#" + node.id));
                        }
                    }
                }
            }else{
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                        }
                    }
                }
            }
        }else if(patternDimension.test(node.id)){
            items = {
                "delete": {
                    "label": "Delete Rule",
                    "action": function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            }
        }else if(patternNumbers.test(node.id)){
            if(node.children.length ==1){
                items = {
                    "add_number": {
                        "label": "Add Number",
                        "action": function () {
                            //Node : ,
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "comma" + num, "text": ",",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": ", "}
                            }, "last", function () {
                            });
                            num++;

                            //Node : number
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "number" + num, "text": "number",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                        }
                    }
                }
            }else{
                items = {
                    "add_number": {
                        "label": "Add Number",
                        "action": function () {

                            //Node : ,
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "comma" + num, "text": ",",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: true,  // is the node disabled
                                }, a_attr: {"class": "terminal", "program": ", "}
                            }, "last", function () {
                            });
                            num++;

                            //Node : number
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "number" + num, "text": "number",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //$("#lissSyntax").jstree("open_node", $("#" + data.node.id));

                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                        }
                    },
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(node.children);

                            //Node : number
                            $('#lissSyntax').jstree().create_node(node, {
                                "id": "number" + num, "text": "number",
                                state: {
                                    opened: false,  // is the node open
                                    disabled: false,  // is the node disabled
                                }, a_attr: {"class": "non-terminal"}
                            }, "last", function () {
                            });
                            num++;

                            //$("#lissSyntax").jstree("open_node", $("#" + data.node.id));

                            //Refresh the content of TextArea
                            //liss.setText(getProgramLiss());
                        }
                    }
                }
            }
        }else if(patternNumber.test(node.id)){
            var nodeParent = $("#lissSyntax").jstree(this).get_node(node.parent);
            var positionNodeInParent = function(nodeParent,node){
                var res=-1;
                for(var i=0; i < nodeParent.children.length;i++){
                    if(nodeParent.children[i]===node.id){res=i;}
                }
                return res;
            };
            var position = positionNodeInParent(nodeParent,node);


            if(nodeParent.children.length===1){
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {var numb
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                        }
                    }
                }
            }else if( nodeParent.children.length>1 && position >= 2 && position!= -1){
                items = {
                    "delete": {
                        "label": "Delete Rule",
                        "action": function () {
                            $("#lissSyntax").jstree(this).delete_node(nodeParent.children[position]);
                            $("#lissSyntax").jstree(this).delete_node(nodeParent.children[position-1]);
                        }
                    }
                }
            }
        }
        return items;
    }


    /*****************WHEN NODE IS SELECTED WHAT DO WE DO RULES****************/

    $('#lissSyntax').on("select_node.jstree", function (e, data) {

        //Puting context for editing, depending the context
        if(patternIdentifier.test(data.node.id) || patternInt.test(data.node.id)){
            //Edit the node by clicking it!!!!!!!
            var ref = $('#lissSyntax').jstree(true), sel = ref.get_selected();
            if(!sel.length) { return false; }
            sel = sel[0];
            ref.edit(sel);
        }


        //Creating the tree rules of Liss syntax
        //if(validateLissSyntax){
            //liss.debugger("VALIDATION: "+validateLissSyntax());
            if (data.node.id == "liss") {
                if(data.node.children.length < 1) {
                    //Node : program
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "program_liss", "text": "program",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": "program "}
                    }, "last", function () {
                    });

                    //Node : identifier
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "identifier"+num, "text": "IDENTIFIER",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "terminal edit", "program": "", "expressionregularrule": "ID"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : body
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "body",
                        "text": "body",
                        a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });

                    //Instruction for opening the branch
                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else{
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                }
            } else if (data.node.id == "body") {
                if(data.node.children < 1) {
                    //Node : {
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "parenthesis_open_body"+num, "text": "{",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": "{\n"}
                    }, "last", function () {
                    });
                    num++;
                    tab++;

                    //Node : declarations_t
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "declarations_body", "text": "declarations",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": produceTabs(tab) + "declarations\n"}
                    }, "last", function () {
                    });
                    tab++;

                    //Node : declarations_nt
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "declarations" + num, "text": "declarations",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    tab--;
                    //Node : statements_t
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "statements_body", "text": "statements",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": produceTabs(tab) + "statements \n"}
                    }, "last", function () {
                    });

                    //Node : statements_nt
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "statements" + num, "text": "statements",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    tab--;
                    //Node : }
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "parenthesis_close_body"+num, "text": "}",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": produceTabs(tab) + "}"}
                    }, "last", function () {
                    });
                    num++;

                    //We need to reintroduce the effect of the tab for further work/context
                    tab++;
                    tab++;
                    //Instruction for opening the branch
                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else{
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                    tab--;
                    tab--;
                }
            } else if (patternDeclarations.test(data.node.id)) {
                if(data.node.children<2) {
                    //Node : variable_declaration*
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "variables_declarations"+num, "text": "variable_declaration*",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;
                    //tab++;

                    //Node : subprogram_definition*
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "subprograms_definitions"+num, "text": "subprogram_definition*",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;
                    //tab++;

                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else{
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                }
            }else if(patternVariablesDeclarations.test(data.node.id)){
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternSubprogramsDefinitions.test(data.node.id)){
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternVariableDeclaration.test(data.node.id)){
                if(data.node.children<4){
                    //Node : vars+
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "vars" + num, "text": "vars+",
                        state: {
                            opened: true,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : var
                    $('#lissSyntax').jstree().create_node(data.node.children[0], {
                        "id": "var" + num, "text": "var",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : ->
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "arrow"+num, "text": "->",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": " -> "}
                    }, "last", function () {
                    });
                    num++;

                    //Node : type
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "type" + num, "text": "type",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : ;
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "semicolon"+num, "text": ";",
                        state: {
                            opened: false,  // is the node open
                            disabled: true,  // is the node disabled
                        }, a_attr: {"class": "terminal", "program": ";\n"}
                    }, "last", function () {
                    });
                    num++;

                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else{
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                }
            }else if(patternVars.test(data.node.id)){
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternVar.test(data.node.id)){
                var nodeParent = $("#lissSyntax").jstree(this).get_node(data.node.parent);
                if(data.node.children<2 && nodeParent.children[0] === data.node.id) {
                    //Node : identifier_var
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "identifier" + num, "text": "IDENTIFIER",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "terminal edit", "program": produceTabs(tab)+"", "expressionregularrule": "ID"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : value_var
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "value_var" + num, "text": "value_var",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else if(data.node.children<2 && nodeParent.children.length > 1){
                    //Node : identifier_var
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "identifier" + num, "text": "IDENTIFIER",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "terminal edit", "program": "", "expressionregularrule": "ID"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : value_var
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "value_var" + num, "text": "value_var",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else if(data.node.children.length===2){
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                }
            }else if(patternValueVar.test(data.node.id)){
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternInicVar.test(data.node.id)) {
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternType.test(data.node.id)){
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternDimension.test(data.node.id)){
                if(data.node.children<1){
                    //Node : numbers+
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "numbers" + num, "text": "numbers+",
                        state: {
                            opened: true,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    //Node : number
                    $('#lissSyntax').jstree().create_node(data.node.children[0], {
                        "id": "number" + num, "text": "number",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "non-terminal"}
                    }, "last", function () {
                    });
                    num++;

                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else{
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                }
            }else if(patternNumbers.test(data.node.id)){
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            }else if(patternNumber.test(data.node.id)){
                if(data.node.children.length<1){
                    //Node : int
                    $('#lissSyntax').jstree().create_node(data.node, {
                        "id": "int" + num, "text": "NUMBER",
                        state: {
                            opened: false,  // is the node open
                            disabled: false,  // is the node disabled
                        }, a_attr: {"class": "terminal edit", "program": "", "expressionregularrule": "NBR"}
                    }, "last", function () {
                    });
                    num++;

                    $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
                }else{
                    setTimeout(function () {
                        data.instance.show_contextmenu(data.node)
                    }, 100);
                }
            }else if(patternSubprogramDefinition.test(data.node.id)){

            }

    });


    //Code for ContextMenu to open with left click
    /*setTimeout(function () {
     data.instance.show_contextmenu(data.node)
     }, 100);*/
</script>
</body>
</html>