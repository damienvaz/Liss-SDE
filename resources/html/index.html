<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>jsTree test</title>
    <!-- 2 load the theme CSS file -->
    <link rel="stylesheet" href="dist/themes/default/style.css" />
</head>
<body>


<div id="lissSyntax"></div>
<!--<input type="button" value="Load" onclick="loadTreeJSON()"/>-->

<!-- 4 include the jQuery library -->
<script src="dist/libs/jquery.min.js"></script>
<!-- 5 include the minified jstree source -->
<!--<script src="dist/jstree.min.js"></script>-->
<script src="dist/jstree.min.js"></script>
<script>
    var num=0;
    var tab=0;

    function getStateJson(){
        num = liss.getNum();
        tab = liss.getTab();
    }

    function setStateJson(){
        liss.setStateJsonLiss(num,tab);
    }

    function produceTabs(tab){
        var res = "";
        for (i = 0; i < tab; i++) {
            // res +=  "\t";
            res +=  "    ";
        }
        return res;
    }

    function saveTreeJSON(){
        var v = $('#lissSyntax').jstree(true).get_json('#', {flat:true});
        setStateJson();
        var num = ""+liss.getNum();
        var tab = ""+liss.getTab();
        var mytext = JSON.stringify(v);
        mytext = num+"\n"+tab+"\n"+mytext;
        //alert(mytext);
        //liss.debugger(mytext);
        return mytext;
    }

    function loadTreeJSON(){
        //liss.debugger(liss.getJSON());
        //var j = [{"id":"liss","text":"liss","icon":true,"li_attr":{"id":"liss"},"a_attr":{"href":"#","class":"non-terminal","id":"liss_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{},"parent":"#"},{"id":"program_liss","text":"program","icon":true,"li_attr":{"id":"program_liss"},"a_attr":{"href":"#","class":"terminal","program":"program ","id":"program_liss_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":true},"data":{},"parent":"liss"},{"id":"identifier_liss","text":"d234","icon":true,"li_attr":{"id":"identifier_liss"},"a_attr":{"href":"#","class":"terminal edit correct","program":"","expressionregularrule":"ID","id":"identifier_liss_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":false},"data":{},"parent":"liss"},{"id":"body","text":"body","icon":true,"li_attr":{"id":"body"},"a_attr":{"href":"#","class":"non-terminal","id":"body_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{},"parent":"liss"},{"id":"parenthesis_open_body","text":"{","icon":true,"li_attr":{"id":"parenthesis_open_body"},"a_attr":{"href":"#","class":"terminal","program":"{\n","id":"parenthesis_open_body_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":true},"data":{},"parent":"body"},{"id":"declarations_body","text":"declarations","icon":true,"li_attr":{"id":"declarations_body"},"a_attr":{"href":"#","class":"terminal","program":"    declarations\n","id":"declarations_body_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":true},"data":{},"parent":"body"},{"id":"declarations","text":"declarations","icon":true,"li_attr":{"id":"declarations"},"a_attr":{"href":"#","class":"non-terminal","id":"declarations_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{},"parent":"body"},{"id":"declaration","text":"declaration*","icon":true,"li_attr":{"id":"declaration"},"a_attr":{"href":"#","class":"non-terminal","id":"declaration_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{},"parent":"declarations"},{"id":"variable_declaration2","text":"variable_declaration","icon":true,"li_attr":{"id":"variable_declaration2"},"a_attr":{"href":"#","class":"non-terminal","id":"variable_declaration2_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{},"parent":"declaration"},{"id":"int3","text":"12456689","icon":true,"li_attr":{"id":"int3"},"a_attr":{"href":"#","class":"terminal edit correct","program":"        ","expressionregularrule":"NBR","id":"int3_anchor"},"state":{"loaded":true,"opened":false,"selected":true,"disabled":false},"data":{},"parent":"variable_declaration2"},{"id":"variable_declaration0","text":"variable_declaration","icon":true,"li_attr":{"id":"variable_declaration0"},"a_attr":{"href":"#","class":"non-terminal","id":"variable_declaration0_anchor"},"state":{"loaded":true,"opened":true,"selected":false,"disabled":false},"data":{},"parent":"declaration"},{"id":"int1","text":"1234","icon":true,"li_attr":{"id":"int1"},"a_attr":{"href":"#","class":"terminal edit correct","program":"        ","expressionregularrule":"NBR","id":"int1_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":false},"data":{},"parent":"variable_declaration0"},{"id":"statements_body","text":"statements","icon":true,"li_attr":{"id":"statements_body"},"a_attr":{"href":"#","class":"terminal","program":"    statements \n","id":"statements_body_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":true},"data":{},"parent":"body"},{"id":"statements","text":"statements","icon":true,"li_attr":{"id":"statements"},"a_attr":{"href":"#","class":"non-terminal","id":"statements_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":false},"data":{},"parent":"body"},{"id":"parenthesis_close_body","text":"}","icon":true,"li_attr":{"id":"parenthesis_close_body"},"a_attr":{"href":"#","class":"terminal","program":"}","id":"parenthesis_close_body_anchor"},"state":{"loaded":true,"opened":false,"selected":false,"disabled":true},"data":{},"parent":"body"}];
        //liss.debugger("Hello1");
        //var j = "[{\"id\":\"liss\",\"text\":\"liss\",\"icon\":true,\"li_attr\":{\"id\":\"liss\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"liss_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"#\"},{\"id\":\"program_liss\",\"text\":\"program\",\"icon\":true,\"li_attr\":{\"id\":\"program_liss\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal\",\"program\":\"program \",\"id\":\"program_liss_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":true},\"data\":{},\"parent\":\"liss\"},{\"id\":\"identifier_liss\",\"text\":\"d234\",\"icon\":true,\"li_attr\":{\"id\":\"identifier_liss\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal edit correct\",\"program\":\"\",\"expressionregularrule\":\"ID\",\"id\":\"identifier_liss_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"liss\"},{\"id\":\"body\",\"text\":\"body\",\"icon\":true,\"li_attr\":{\"id\":\"body\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"body_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"liss\"},{\"id\":\"parenthesis_open_body\",\"text\":\"{\",\"icon\":true,\"li_attr\":{\"id\":\"parenthesis_open_body\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal\",\"program\":\"{\\n\",\"id\":\"parenthesis_open_body_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":true},\"data\":{},\"parent\":\"body\"},{\"id\":\"declarations_body\",\"text\":\"declarations\",\"icon\":true,\"li_attr\":{\"id\":\"declarations_body\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal\",\"program\":\"    declarations\\n\",\"id\":\"declarations_body_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":true},\"data\":{},\"parent\":\"body\"},{\"id\":\"declarations\",\"text\":\"declarations\",\"icon\":true,\"li_attr\":{\"id\":\"declarations\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"declarations_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"body\"},{\"id\":\"declaration\",\"text\":\"declaration*\",\"icon\":true,\"li_attr\":{\"id\":\"declaration\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"declaration_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"declarations\"},{\"id\":\"variable_declaration2\",\"text\":\"variable_declaration\",\"icon\":true,\"li_attr\":{\"id\":\"variable_declaration2\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"variable_declaration2_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"declaration\"},{\"id\":\"int3\",\"text\":\"12456689\",\"icon\":true,\"li_attr\":{\"id\":\"int3\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal edit correct\",\"program\":\"        \",\"expressionregularrule\":\"NBR\",\"id\":\"int3_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":true,\"disabled\":false},\"data\":{},\"parent\":\"variable_declaration2\"},{\"id\":\"variable_declaration0\",\"text\":\"variable_declaration\",\"icon\":true,\"li_attr\":{\"id\":\"variable_declaration0\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"variable_declaration0_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"declaration\"},{\"id\":\"int1\",\"text\":\"1234\",\"icon\":true,\"li_attr\":{\"id\":\"int1\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal edit correct\",\"program\":\"        \",\"expressionregularrule\":\"NBR\",\"id\":\"int1_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"variable_declaration0\"},{\"id\":\"statements_body\",\"text\":\"statements\",\"icon\":true,\"li_attr\":{\"id\":\"statements_body\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal\",\"program\":\"    statements \\n\",\"id\":\"statements_body_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":true},\"data\":{},\"parent\":\"body\"},{\"id\":\"statements\",\"text\":\"statements\",\"icon\":true,\"li_attr\":{\"id\":\"statements\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"statements_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"body\"},{\"id\":\"parenthesis_close_body\",\"text\":\"}\",\"icon\":true,\"li_attr\":{\"id\":\"parenthesis_close_body\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal\",\"program\":\"}\",\"id\":\"parenthesis_close_body_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":true},\"data\":{},\"parent\":\"body\"}]";
        var j = "[{\"id\":\"liss\",\"text\":\"liss\",\"icon\":true,\"li_attr\":{\"id\":\"liss\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"liss_anchor\"},\"state\":{\"loaded\":true,\"opened\":true,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"#\"},{\"id\":\"program_liss\",\"text\":\"program\",\"icon\":true,\"li_attr\":{\"id\":\"program_liss\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal\",\"program\":\"program \",\"id\":\"program_liss_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":true},\"data\":{},\"parent\":\"liss\"},{\"id\":\"identifier_liss\",\"text\":\"cr5f67\",\"icon\":true,\"li_attr\":{\"id\":\"identifier_liss\"},\"a_attr\":{\"href\":\"#\",\"class\":\"terminal edit correct\",\"program\":\"\",\"expressionregularrule\":\"ID\",\"id\":\"identifier_liss_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":true,\"disabled\":false},\"data\":{},\"parent\":\"liss\"},{\"id\":\"body\",\"text\":\"body\",\"icon\":true,\"li_attr\":{\"id\":\"body\"},\"a_attr\":{\"href\":\"#\",\"class\":\"non-terminal\",\"id\":\"body_anchor\"},\"state\":{\"loaded\":true,\"opened\":false,\"selected\":false,\"disabled\":false},\"data\":{},\"parent\":\"liss\"}]";
        var test = liss.getJSON();

        //liss.debugger(j);
        //liss.debugger(test);
        //var jsonString = liss.getJSON();
        //liss.debugger("Hello2");
        //liss.debugger(liss.getJSON());
        //console.log(j);
        //liss.debugger(liss.getJSON());
        //json = JSON.parse(liss.getJSON());
        //var json = JSON.parse(j);
        var json = JSON.parse(test);
        if($('#lissSyntax').jstree(true)){
            $('#lissSyntax').jstree(true).settings.core.data = json;
            $('#lissSyntax').jstree(true).refresh();
            liss.setText(getProgramLiss());
            //liss.debugger("NUM: "+num+", TAB: "+tab);
        }
    }



    function getProgramLiss(){
        var res="";
        $('.terminal').each(function(){
            //var text = $(this).text();
            var text;
            if($(this).hasClass("edit")){
                if($(this).hasClass("correct")) {
                    if ($(this).attr("expressionregularrule") === "ID") {
                        text = $(this).attr("program") + $(this).text();//+$(this).attr("program");
                    } else if ($(this).attr("expressionregularrule") === "NBR") {
                        text = $(this).attr("program") + $(this).text() + "\n";
                    }
                }
            }else{
                console.log("ELSE: ");
                console.log($(this));
                text = $(this).attr("program");
            }
            res += text;
        });

        return res;
    }

    /*var validateLissSyntax = true;
    $('#lissSyntax').on("open_node.jstree select_node.jstree",function(){
        validateLissSyntax = true;

        //Force reload tree
        //$('#lissSyntax').jstree('refresh');

        console.log("BEFORE_Node opened: "+validateLissSyntax);
        $('.edit').each(function(){
            console.log("WOOT");
            if($(this).hasClass("warning") || (!$(this).hasClass("warning") && !$(this).hasClass("correct"))){
                //res = false;
                console.log($(this));
                if($(this).hasClass("correct")){
                    console.log("It has class correct");
                }else if($(this).hasClass("warning")){
                    console.log("It has class warning");
                }else{
                    console.log("It doesn't have any classes");
                }
                validateLissSyntax = false;
            }
        });
        console.log("AFTER_Node opened: "+validateLissSyntax);
        console.log("**********************");
    });*/

    //Get the program to a singleton variable
    //$('#lissSyntax').on('mouseenter',function(){ //event optional : click
    //$('#lissSyntax').on('changed.jstree set_text.jstree',function(){ //event optional : click
    $('#lissSyntax').on('mouseenter',function(){ //event optional : click
        //console.log("kappa");
        var res = getProgramLiss();
        liss.setText(res);
    });

    $('#lissSyntax').on("set_text.jstree",function(event,object){
        var id = object.obj.a_attr.id;
        var node = $("#"+id);
        //ID : ('a'..'z'|'A'..'Z')('a'..'z'|'A'..'Z'|'0'..'9'|'_')* //removi o uso do signal '-' conflitos com os valores do signal
        var patternId = /^([a-z]|[A-Z])([a-z]|[A-Z]|[0-9]|[_])*$/;
        //NBR : ('0'..'9')+
        var patternNbr = /^[0-9]+$/;

        //Pr.C.:Check if the node has an expression regular rule as attribute
        if(node.is("[expressionregularrule]") && node.hasClass("edit")){
            //Pr.C.:Check which type of node is it. (Ex.: NBR|ID|STR)
            if(node.attr("expressionregularrule")==="NBR"){
                //console.log("regra NBR");
                //Pr.C:When edition is actived, the text element is empty
                if(object.obj.text!=="") {
                    //Pr.C.: Check the regular expression of NBR
                    if (patternNbr.test(object.obj.text)) {
                        if(/warning/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" warning", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.removeClass("warning");
                            node.addClass("correct");
                        }else if(!/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.addClass("correct");
                        }
                    } else {
                        if(/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" correct", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" warning";
                            //Changing value now for the DOM html document structure
                            node.removeClass("correct");
                            node.addClass("warning");
                        }else if(!/warning/.test(object.obj.a_attr.class)){
                            //Changing value now for the DOM html document structure
                            node.addClass("warning");
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" warning";
                        }
                    }
                }
            }else if(node.attr("expressionregularrule")==="ID"){
                //console.log("regra ID");
                //Pr.C:When edition is actived, the text element is empty
                if(object.obj.text!=="") {
                    //Pr.C.: Check the regular expression of NBR
                    if (patternId.test(object.obj.text)) {
                        if(/warning/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" warning", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.removeClass("warning");
                            node.addClass("correct");
                        }else if(!/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" correct";
                            //Changing value now for the DOM html document structure
                            node.addClass("correct");
                        }
                    } else {
                        if(/correct/.test(object.obj.a_attr.class)){
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            var s = object.obj.a_attr.class.replace(" correct", "");
                            object.obj.a_attr.class = s;
                            object.obj.a_attr.class+=" warning";
                            //Changing value now for the DOM html document structure
                            node.removeClass("correct");
                            node.addClass("warning");
                        }else if(!/warning/.test(object.obj.a_attr.class)){
                            //Changing value now for the DOM html document structure
                            node.addClass("warning");
                            //Changing value for the jstree structure data because it isn't reflected to the DOM html document
                            object.obj.a_attr.class+=" warning";
                        }
                    }
                    console.log(object.obj.a_attr.class);
                }
            }else if(node.attr("expressionregularrule")==="STR"){
                console.log("regra STR");
                //FAZER ESTA PARTE
            }

        }
    });

    /**************************************************************************/


    $("#lissSyntax").jstree({
        "core": {
            // so that create works
            "themes": {
                "icons": false
            },
            "check_callback": true,
            "data": [{
                "id": "liss", "parent": "#", "text": "liss", a_attr: {"class": "non-terminal"}
            }]
        },
        "plugins": ["contextmenu"],
        "contextmenu": {
            "items": customMenu
        }
    });

    function customMenu(node) {
        var items = null;

        if( node.id == "liss" && node.children.length==3){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            };
        }else if( node.id == "body" && node.children.length==6){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            };
        }else if(node.id == "declarations" && node.children.length==1){
            items = {
                "delete" : {
                    "label" : "Delete Rule",
                    "action" : function () {
                        $("#lissSyntax").jstree(this).delete_node(node.children);
                        //Refresh the content of TextArea
                        liss.setText(getProgramLiss());
                    }
                }
            };
        }else if(node.id=="declaration"){
            if(node.children.length<1){
                items = {
                    "add_variable_declaration" : {
                        "label" : "Add variable declaration",
                        "action" : function () {
                            //Node : variable_declaration
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "variable_declaration"+num, "text" : "variable_declaration",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "first", function(){});

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    },
                    "add_subprogram_definition" : {
                        "label" : "Add subprogram definition",
                        "action" : function () {
                            //Node : subprogram_definition
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "subprogram_definition"+num, "text" : "subprogram_definition",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "last", function(){});

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    }
                };
            }else{
                items = {
                    "add_variable_declaration" : {
                        "label" : "Add variable declaration",
                        "action" : function () {
                            //Node : variable_declaration
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "variable_declaration"+num, "text" : "variable_declaration",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "first", function(){});

                            num++;

                            //Instruction for opening the branch
                            //$("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    },
                    "add_subprogram_definition" : {
                        "label" : "Add subprogram definition",
                        "action" : function () {
                            //Node : subprogram definition
                            $('#lissSyntax').jstree().create_node(node,  { "id" : "subprogram_definition"+num, "text" : "subprogram_definition",
                                state       : {
                                    opened    : false,  // is the node open
                                    disabled  : false,  // is the node disabled
                                }, a_attr : { "class" : "non-terminal"}
                            }, "last", function(){});

                            num++;

                            //Instruction for opening the branch
                            $("#lissSyntax").jstree("open_node", $("#"+node.id));
                        }
                    },
                    "delete" : {
                        "label" : "Delete Rule",
                        "action" : function () {
                            //liss.debugger("WOOT1");
                            //liss.debugger(node.children);
                            $("#lissSyntax").jstree(this).delete_node(node.children);
                            //Refresh the content of TextArea
                            liss.setText(getProgramLiss());
                            //liss.debugger("WOOT2");
                        }
                    }
                };
            }
        }
        return items;
    }


    /*****************WHEN NODE IS SELECTED WHAT DO WE DO RULES****************/

    $('#lissSyntax').on("select_node.jstree", function (e, data) {
        //Regular expression for some node id !!!
        var patternVariableDeclaration = /^variable_declaration[0-9]+$/;
        var patternSubprogramDefinition = /^subprogram_definition[0-9]+$/;
        var patternInt = /^int[0-9]+$/;


        //Puting context for editing, depending the context
        if(data.node.id == "identifier_liss" || patternInt.test(data.node.id)){
            //Edit the node by clicking it!!!!!!!
            var ref = $('#lissSyntax').jstree(true), sel = ref.get_selected();
            if(!sel.length) { return false; }
            sel = sel[0];
            ref.edit(sel);
        }


        //Creating the tree rules of Liss syntax
        //if(validateLissSyntax){
            //liss.debugger("VALIDATION: "+validateLissSyntax());
            if (data.node.id == "liss" && data.node.children.length < 1) {
                //Node : program
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "program_liss", "text": "program",
                    state: {
                        opened: false,  // is the node open
                        disabled: true,  // is the node disabled
                    }, a_attr: {"class": "terminal", "program": "program "}
                }, "last", function () {
                });

                //Node : identifier
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "identifier_liss", "text": "IDENTIFIER",
                    state: {
                        opened: false,  // is the node open
                        disabled: false,  // is the node disabled
                    }, a_attr: {"class": "terminal edit", "program": "", "expressionregularrule": "ID"}
                }, "last", function () {
                });

                //Node : body
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "body",
                    "text": "body",
                    a_attr: {"class": "non-terminal"}
                }, "last", function () {
                });

                //Instruction for opening the branch
                $("#lissSyntax").jstree("open_node", $("#" + data.node.id));

            } else if (data.node.id == "body" && data.node.children < 1) {
                //Node : {
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "parenthesis_open_body", "text": "{",
                    state: {
                        opened: false,  // is the node open
                        disabled: true,  // is the node disabled
                    }, a_attr: {"class": "terminal", "program": "{\n"}
                }, "last", function () {
                });
                tab++;

                //Node : declarations_t
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "declarations_body", "text": "declarations",
                    state: {
                        opened: false,  // is the node open
                        disabled: true,  // is the node disabled
                    }, a_attr: {"class": "terminal", "program": produceTabs(tab) + "declarations\n"}
                }, "last", function () {
                });
                tab++;

                //Node : declarations_nt
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "declarations", "text": "declarations",
                    state: {
                        opened: false,  // is the node open
                        disabled: false,  // is the node disabled
                    }, a_attr: {"class": "non-terminal"}
                }, "last", function () {
                });

                tab--;
                //Node : statements_t
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "statements_body", "text": "statements",
                    state: {
                        opened: false,  // is the node open
                        disabled: true,  // is the node disabled
                    }, a_attr: {"class": "terminal", "program": produceTabs(tab) + "statements \n"}
                }, "last", function () {
                });

                //Node : statements_nt
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "statements", "text": "statements",
                    state: {
                        opened: false,  // is the node open
                        disabled: false,  // is the node disabled
                    }, a_attr: {"class": "non-terminal"}
                }, "last", function () {
                });

                tab--;
                //Node : }
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "parenthesis_close_body", "text": "}",
                    state: {
                        opened: false,  // is the node open
                        disabled: true,  // is the node disabled
                    }, a_attr: {"class": "terminal", "program": produceTabs(tab) + "}"}
                }, "last", function () {
                });

                //We need to reintroduce the effect of the tab for further work/context
                tab++;
                tab++;
                //Instruction for opening the branch
                $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
            } else if (data.node.id == "declarations" && data.node.children < 1) {
                //Node : declaration
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "declaration", "text": "declaration*",
                    state: {
                        opened: false,  // is the node open
                        disabled: false,  // is the node disabled
                    }, a_attr: {"class": "non-terminal"}
                }, "last", function () {
                });
                //tab++;
                //Instruction for opening the branch
                $("#lissSyntax").jstree("open_node", $("#" + data.node.id));
            } else if (data.node.id == "declaration") {//&& data.node.children<1){

                //Code for ContextMenu to open with left click
                setTimeout(function () {
                    data.instance.show_contextmenu(data.node)
                }, 100);
            } else if (patternVariableDeclaration.test(data.node.id) && data.node.children < 1) {
                //Node : declaration
                $('#lissSyntax').jstree().create_node(data.node, {
                    "id": "int" + num, "text": "NUMBER",
                    state: {
                        opened: false,  // is the node open
                        disabled: false,  // is the node disabled
                    }, a_attr: {"class": "terminal edit", "program": produceTabs(tab), "expressionregularrule": "NBR"}
                }, "last", function () {
                });
                num++;


            } else if (patternSubprogramDefinition.test(data.node.id)) {

            }
        //}

    });

    //loadTreeJSON();

</script>
</body>
</html>